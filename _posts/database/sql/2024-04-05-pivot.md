---
title: SQL - PIVOT (Oracle DB)
date: 2024-04-05 14:00:00 +09:00
categories: [DB, sql]
tags:
  [
    Data,
    DB,
    Datebase,
    oracle,
    sql,
  ]
---

## 1. 행과 열의 변환

일반적으로 집계 작업과 함께 사용되어 통계적 데이터를 반환함

### CASE를 이용하는 방법

```sql
SELECT
SUM(CASE WHEN DEPTNO=10 THEN 1 ELSE 0 END) AS DEPT_10,
SUM(CASE WHEN DEPTNO=20 THEN 1 ELSE 0 END) AS DEPT_20,
SUM(CASE WHEN DEPTNO=30 THEN 1 ELSE 0 END) AS DEPT_30
FROM EMP
ORDER BY DEPTNO;

/*
DEPT_10, DEPT_20, DEPT_30
3	5	6
*/
```

<hr>

### DECODE를 이용하는 방법

```sql
SELECT JOB
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'1',1,0)) "1월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'2',1,0)) "2월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'3',1,0)) "3월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'4',1,0)) "4월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'5',1,0)) "5월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'6',1,0)) "6월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'7',1,0)) "7월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'8',1,0)) "8월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'9',1,0)) "9월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'10',1,0)) "10월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'11',1,0)) "11월"
,SUM(DECODE(TO_CHAR(HIREDATE, 'FMMM'),'12',1,0)) "12월"
FROM EMP
GROUP BY JOB;

/*
JOB, 1월, 2월, 3월, 4월, 5월, 6월, 7월, 8월, 9월, 10월, 11월, 12월
SALESMAN	0	2	0	0	0	0	0	0	2	0	0	0
CLERK	2	0	0	0	0	0	0	0	0	1	0	0
PRESIDENT	0	0	0	0	0	0	0	0	0	0	1	0
MANAGER	0	0	0	2	0	1	0	0	0	0	0	0
ANALYST	0	0	0	0	0	0	0	0	0	3	0	0
*/
```

<hr><br>

## 2. PIVOT 함수

### 특징

- 오라클 11g부터 PIVOT 기능을 제공합
- 기존에는 DECODE 함수를 이용하여 로우를 컬럼으로 변경하는 작업 진행
- DECODE의 복잡하고 비직관적인 코드를 조금 더 직관적으로 작성 가능

<hr>

### 사용법

문법은 다음과 같다

```sql
SELECT *
FROM ( 쿼리에 쓰일 테이블 )
PIVOT ( 그룹합수(집계컬럼) FOR 피벗컬럼 IN (피벗컬럼값 AS 별칭 ... ));
```

이 밑은 실사용 예시이다.

```sql
SELECT *
FROM (
    SELECT JOB, DEPTNO, SAL FROM EMP
) 
PIVOT (SUM(SAL) FOR DEPTNO 
IN ('10' AS DEPTNO10, '20' AS DEPTNO20, '30' AS DEPTNO30));

/*
JOB, DEPTNO10, DEPTNO20, DEPTNO30
SALESMAN			5600
CLERK	1300	1100	950
PRESIDENT	5000		
MANAGER	2450	2975	2850
ANALYST		9000	
*/
```

<hr><br>

## 3. 다차원 쿼리

### ROLLUP

모든 행의 소계를 내기 위해 사용

```sql
SELECT JOB, SUM(SAL)
FROM EMP
GROUP BY ROLLUP(JOB);

/*
JOB, SUM(SAL)
ANALYST	9000
CLERK	3350
MANAGER	8275
PRESIDENT	5000
SALESMAN	5600
	31225  >> 총합
*/
```

<hr>

### CUBE 

모든 컬럼의 소계를 만듦

```sql
SELECT DEPTNO, JOB, SUM(SAL)
FROM EMP
GROUP BY CUBE(DEPTNO, JOB)
ORDER BY DEPTNO, JOB;

/*
DEPTNO, JOB, SUM(SAL)
10	CLERK	1300
10	MANAGER	2450
10	PRESIDENT	5000
10		8750
20	ANALYST	9000
20	CLERK	1100
20	MANAGER	2975
20		13075
30	CLERK	950
30	MANAGER	2850
30	SALESMAN	5600
30		9400
	ANALYST	9000
	CLERK	3350
	MANAGER	8275
	PRESIDENT	5000
	SALESMAN	5600
		31225
*/
```